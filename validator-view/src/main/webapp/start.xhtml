<?xml version="1.0" encoding="UTF-8"?>
<ui:composition
        xmlns:ui="http://java.sun.com/jsf/facelets"
        xmlns:f="http://java.sun.com/jsf/core"
        xmlns:tr="http://myfaces.apache.org/trinidad"
        xmlns:trh="http://myfaces.apache.org/trinidad/html"
        xmlns:h="http://java.sun.com/jsf/html"
        xmlns:c="http://java.sun.com/jstl/core"
        xmlns:ebi="http://ebi.ac.uk/faces/components"

        template="/WEB-INF/facelets/layout/compliance-template-ebi.xhtml">

<!-- Mandatorty params -->
<ui:param name="sectionTitle" value="Input Form"/>

<ui:define name="windowTitle">
    <tr:outputText value="#{ebiTest['webapp.name']}"/>
</ui:define>

<ui:define name="content">

<tr:messages id="allMessages" />

<!-- Description -->
<section class = "grid_24">
    <h2>Overview</h2>
    <tr:group>

        <dd>
            The PSI Validator currently validate files in
            <tr:goLink destination="http://www.psidev.info/index.php?q=node/60" targetFrame="_blank">
                <tr:outputText value=" PSI-MI XML 2.5 "/>
            </tr:goLink>
            ,
            <tr:goLink destination="http://www.psidev.info/index.php?q=node/281" targetFrame="_blank">
                <tr:outputText value=" PSI-PAR "/>
            </tr:goLink>
            ,
            <tr:goLink destination="http://code.google.com/p/psicquic/wiki/MITAB25Format" targetFrame="_blank">
                <tr:outputText value=" MITAB 2.5 "/>
            </tr:goLink>
            ,
            <tr:goLink destination="http://code.google.com/p/psicquic/wiki/MITAB26Format" targetFrame="_blank">
                <tr:outputText value=" MITAB 2.6 "/>
            </tr:goLink>
            and
            <tr:goLink destination="http://code.google.com/p/psicquic/wiki/MITAB27Format" targetFrame="_blank">
                <tr:outputText value=" MITAB 2.7 "/>
            </tr:goLink>
            format.
        </dd>
    </tr:group>
    <br/>
</section>

<!-- File upload -->
<section class="grid_24">
    <h2>PSI-MI validation</h2>

    <tr:form id="ebiForm" usesUpload="true" styleClass="grid_24">
        <div class="grid_24">
            <fieldset id="loadFileFld">
                <legend>File upload</legend>
                <!-- source -->
                <div class="grid_8">
                    <tr:selectOneRadio id="sourceSelector" value="#{psiValidatorController.uploadLocalFile}"
                                       label="Source:"
                                       inlineStyle="width:auto" onclick="displayFileUpload()">
                        <tr:selectItem label="From local file" value="true"/>
                        <tr:selectItem label="From URL" value="false"/>

                    </tr:selectOneRadio>
                </div>
                <div class="grid_16">
                    <!-- File/URL input -->
                    <tr:inputFile id="my_input_file" columns="40" label="File:"
                                  value="#{psiValidatorController.psiFile}" styleClass="localFileUpload"/>
                    <tr:inputText id="inputUrl" label="URL:"
                                  columns="40" value="#{psiValidatorController.psiUrl}"
                                  styleClass="urlUpload"/>
                    <tr:panelList>
                        <tr:outputText value="Single MI file"/>
                        <tr:outputText value="ZIP file containing one MI file (if several MI files, only one will be validated)"/>
                        <tr:commandLink action="#{psiValidatorController.loadExample}"><tr:outputText value="Load an example"/></tr:commandLink>
                    </tr:panelList>
                </div>
            </fieldset>
        </div>
        <div class="grid_24">
            <fieldset id="scopePanelFld">
                <legend>Model and scope selection</legend>

                <div class="grid_8">
                    <tr:selectOneRadio id="modelSelector" value="#{psiValidatorController.selectDefaultModel}"
                                       label="Model:"
                                       inlineStyle="width:auto" onclick="displayModel()">
                        <tr:selectItem label="Molecular Interactions" value="true"/>
                        <tr:selectItem label="Protein Affinity Reagents" value="false"/>

                    </tr:selectOneRadio>
                </div>
                <div class="grid_16">
                    <div class="miScopes">
                        <div class="grid_16">
                            <tr:selectOneRadio id="scopeSelector" value="#{psiValidatorController.validationScope}" styleClass="validatorScopes">
                                <tr:selectItem label="File Syntax Only" value="SYNTAX"/>
                                <tr:selectItem label="Controlled Vocabulary Usage" value="CV_ONLY"/>
                                <tr:selectItem label="PSI-MI" shortDesc="Basic checks for PSI-MI" value="PSI_MI"/>
                                <tr:selectItem label="MIMIx" shortDesc="Minimum Information about a Molecular Interaction guidelines" value="MIMIX"/>
                                <tr:selectItem label="IMEx" shortDesc="International Molecular Exchange guidelines" value="IMEX"/>
                                <tr:selectItem label="Customized rules" value="CUSTOMIZED"/>
                            </tr:selectOneRadio>
                        </div>
                        <div class="grid_16">
                            <div class="grid_10">
                                <tr:selectManyCheckbox id="psimiRules" styleClass="customizeRules" value="#{psiValidatorController.psiMiCustomizedRules}" rendered="#{psiValidatorController.numberOfPsiMiRules > 0}" layout="pageDirection" label="PSI-MI">
                                    <f:selectItems value="#{psiValidatorController.psiMiItemRules}"/>
                                </tr:selectManyCheckbox>
                            </div>
                            <div class="push_15 grid_6">
                                <tr:goButton styleClass="selectAllRules customizeRules" rendered="#{psiValidatorController.numberOfPsiMiRules > 1}" text="Select All"/>
                                <tr:goButton styleClass="unSelectAllRules customizeRules" text="Unselect all" rendered="#{psiValidatorController.numberOfPsiMiRules > 1}"/>
                            </div>
                        </div>
                        <div class="grid_16">
                            <div class="grid_10">
                                <tr:selectManyCheckbox id="mimixRules" styleClass="customizeRules" value="#{psiValidatorController.mimixCustomizedRules}" rendered="#{psiValidatorController.numberOfMimixRules > 0}" layout="pageDirection" label="MIMIx">
                                    <f:selectItems value="#{psiValidatorController.mimixItemRules}" />
                                </tr:selectManyCheckbox>
                            </div>
                            <div class="push_15 grid_6">
                                <tr:goButton styleClass="selectAllRules customizeRules" rendered="#{psiValidatorController.numberOfPsiMiRules > 1}" text="Select All"/>
                                <tr:goButton styleClass="unSelectAllRules customizeRules" text="Unselect all" rendered="#{psiValidatorController.numberOfPsiMiRules > 1}"/>
                            </div>
                        </div>
                        <div class="grid_16">
                            <div class="grid_10">
                                <tr:selectManyCheckbox id="imexRules" styleClass="customizeRules" value="#{psiValidatorController.imexCustomizedRules}" rendered="#{psiValidatorController.numberOfImexRules > 0}" layout="pageDirection" label="IMEx">
                                    <f:selectItems value="#{psiValidatorController.imexItemRules}"/>
                                </tr:selectManyCheckbox>
                            </div>
                            <div class="push_15 grid_6">
                                <tr:goButton styleClass="selectAllRules customizeRules" rendered="#{psiValidatorController.numberOfPsiMiRules > 1}" text="Select All"/>
                                <tr:goButton styleClass="unSelectAllRules customizeRules" rendered="#{psiValidatorController.numberOfPsiMiRules > 1}" text="Unselect all"/>
                            </div>
                        </div>

                    </div>
                    <div class="parScopes grid_16">
                        <tr:selectOneRadio id="scopeSelector2" value="#{psiValidatorController.validationScope}">
                            <tr:selectItem label="File Syntax Only" value="SYNTAX"/>
                            <tr:selectItem label="Controlled Vocabulary Usage" value="CV_ONLY"/>
                        </tr:selectOneRadio>
                    </div>
                </div>

            </fieldset>
        </div>

        <div class="grid_12">
            <h:commandButton id="submit_button" style="display: inline"
                             styleClass="submit"
                             onclick="document.getElementById('progress_image').style.display = 'block';
                                       document.getElementById('submit_button').disabled=true"
                             value="Validate"
                             action="#{psiValidatorController.validate}">
            </h:commandButton>
            <tr:image id="progress_image" inlineStyle="display:none; float:left" source="/images/wait_red_indicator.gif"/>
        </div>
    </tr:form>
</section>


<!-- Uploaded file report table -->
<section class="grid_24">
    <tr:group rendered="#{psiValidatorController.currentPsiReport != null}">
        <h2>Validation summary</h2>

        <trh:tableLayout>
            <trh:rowLayout>
                <trh:cellFormat>

                    <tr:spacer height="20" />

                    <trh:tableLayout borderWidth="0"
                                     cellSpacing="5"
                                     cellPadding="0"
                                     halign="left"
                                     width="600"
                                     rendered="#{psiValidatorController.currentPsiReport != null}">
                        <trh:rowLayout>
                            <trh:cellFormat/>
                            <trh:cellFormat>Filename: </trh:cellFormat>
                            <trh:cellFormat>
                                <tr:outputText value="#{psiValidatorController.currentPsiReport.name}"/>
                            </trh:cellFormat>
                            <trh:cellFormat/>
                        </trh:rowLayout>

                        <trh:rowLayout>
                            <trh:cellFormat>
                                <tr:image source="images/icon_success_sml.gif"
                                          rendered="#{psiValidatorController.currentPsiReport.syntaxValid}"/>
                                <tr:image source="images/icon_warning_sml.gif"
                                          rendered="#{psiValidatorController.currentPsiReport.syntaxStatus == 'warnings'}"/>
                                <tr:image source="images/icon_error_sml.gif"
                                          rendered="#{psiValidatorController.currentPsiReport.syntaxInvalid}"/>
                            </trh:cellFormat>
                            <trh:cellFormat>
                                <tr:outputText value="File Syntax"/>
                            </trh:cellFormat>
                            <trh:cellFormat>
                                <tr:outputText value="#{psiValidatorController.currentPsiReport.syntaxStatus}"/>
                            </trh:cellFormat>
                            <trh:cellFormat>
                                <tr:outputText value="#{psiValidatorController.currentPsiReport.numberOfSyntaxMessages} messages" rendered="#{psiValidatorController.currentPsiReport.numberOfSyntaxMessages > 0}"/>
                            </trh:cellFormat>
                            <trh:cellFormat>
                                <tr:panelHorizontalLayout rendered="#{psiValidatorController.currentPsiReport.syntaxInvalid or psiValidatorController.currentPsiReport.syntaxStatus == 'warnings'}">
                                    <tr:goLink destination="#v_report">
                                        <tr:outputText value="Report"/>
                                    </tr:goLink>
                                </tr:panelHorizontalLayout>
                            </trh:cellFormat>
                        </trh:rowLayout>

                        <!-- TODO It would be desirable to have a row here giving a report on CV usage
                             One could run 2 validators, 1 for CV usage, the other for extra semantic checks
                             and aggregate the errors into the same report.
                        -->

                        <trh:rowLayout rendered="#{psiValidatorController.currentPsiReport.semanticReportAvailable}">
                            <trh:cellFormat>
                                <tr:image source="images/icon_success_sml.gif"
                                          rendered="#{psiValidatorController.currentPsiReport.semanticValid}"/>
                                <tr:image source="images/icon_warning_sml.gif"
                                          rendered="#{psiValidatorController.currentPsiReport.semanticsStatus == 'warnings'}"/>
                                <tr:image source="images/icon_error_sml.gif"
                                          rendered="#{psiValidatorController.currentPsiReport.semanticInvalid}"/>
                            </trh:cellFormat>
                            <trh:cellFormat>
                                <tr:outputText value="MI Semantics"/>
                            </trh:cellFormat>
                            <trh:cellFormat>
                                <tr:outputText value="#{psiValidatorController.currentPsiReport.semanticsStatus}"/>
                            </trh:cellFormat>
                            <trh:cellFormat>
                                <tr:outputText value="#{psiValidatorController.currentPsiReport.numberOfSemanticMessages} messages" rendered="#{psiValidatorController.currentPsiReport.numberOfSemanticMessages > 0}"/>
                            </trh:cellFormat>
                            <trh:cellFormat>
                                <tr:goLink destination="#v_report" rendered="#{psiValidatorController.currentPsiReport.semanticInvalid}">
                                    <tr:outputText value="Report"/>
                                </tr:goLink>
                            </trh:cellFormat>
                        </trh:rowLayout>
                    </trh:tableLayout>

                </trh:cellFormat>
            </trh:rowLayout>

        </trh:tableLayout>
    </tr:group>
</section>


<!-- Validation Report (if any messages) -->
<section class="grid_24">
    <a name="v_report"/>
    <tr:group rendered="#{psiValidatorController.currentPsiReport.semanticReportAvailable or psiValidatorController.currentPsiReport.syntaxInvalid or psiValidatorController.currentPsiReport.syntaxStatus == 'warnings'}">
        <h2>PSI MI Validation Report</h2>

        <tr:outputText value="#{psiValidatorController.currentPsiReport.interactionCount} interaction(s) validated." rendered="#{not psiValidatorController.currentPsiReport.syntaxInvalid}"/>

        <tr:table width="90%" var="msg" value="#{psiValidatorController.currentPsiReport.validatorMessages}">

            <f:facet name="detailStamp">

                <tr:switcher facetName="#{msg.rule['class'].simpleName}" defaultFacet="default" >

                    <f:facet name="default">
                        <tr:panelFormLayout>

                            <tr:panelLabelAndMessage label="Name:">
                                <tr:outputText value="#{msg.rule.name}"/>
                            </tr:panelLabelAndMessage>

                            <tr:panelLabelAndMessage label="Scope:">
                                <tr:outputText value="#{msg.rule.scope}"/>
                            </tr:panelLabelAndMessage>

                            <tr:panelLabelAndMessage label="Description:">
                                <tr:outputText value="#{msg.rule.description}"/>
                            </tr:panelLabelAndMessage>

                            <tr:panelLabelAndMessage label="Tips:" inlineStyle="vertical-align:top;" >
                                <tr:panelList>
                                    <tr:iterator value="#{msg.rule.howToFixTips}" var="tip"
                                                 rendered="#{msg.rule.howToFixTips != null and not empty msg.rule.howToFixTips}">
                                        <tr:outputText value="#{tip}"/>
                                    </tr:iterator>
                                </tr:panelList>
                            </tr:panelLabelAndMessage>
                        </tr:panelFormLayout>
                    </f:facet >

                    <f:facet name="CvRuleImpl">
                        <tr:panelFormLayout>
                            <tr:panelLabelAndMessage label="Type:">
                                <tr:outputText value="Controlled vocabulary usage rule"/>
                            </tr:panelLabelAndMessage>

                            <tr:panelLabelAndMessage label="Scope:">
                                <tr:outputText value="#{msg.rule.name}"/>
                            </tr:panelLabelAndMessage>

                            <tr:panelLabelAndMessage label="Requirement:">
                                <tr:outputText value="#{msg.rule.requirementLevel}"/>
                            </tr:panelLabelAndMessage>
                        </tr:panelFormLayout>
                    </f:facet >

                </tr:switcher>

            </f:facet>

            <tr:column >
                <tr:image source="images/icon_warning_sml.gif" rendered="#{msg.level == 'WARN'}" shortDesc="#{msg.level}"/>
                <tr:image source="images/icon_error_sml.gif" rendered="#{msg.level == 'ERROR'}" shortDesc="#{msg.level}"/>
                <tr:image source="images/icon_error_sml.gif" rendered="#{msg.level == 'FATAL'}" shortDesc="#{msg.level}"/>
            </tr:column>

            <tr:column headerText="Description">
                <tr:outputText value="#{msg.message}" />
            </tr:column>

            <!-- Build a links to respective object anchor's -->
            <tr:column headerText="Context">
                <tr:iterator value="#{msg.context.contexts}" var="ctxt" rows="3" first="0">
                    <h:panelGroup styleClass="errorContext">
                        <tr:goLink destination="##{ctxt.locator}" rendered="#{ctxt.contextWithAnchor}">
                            <nobr><tr:outputText value="#{ctxt.objectLabel} #{ctxt.locator}" /></nobr>
                        </tr:goLink>
                        <tr:outputText value="#{ctxt.objectLabel} #{ctxt.locator}" rendered="#{ not ctxt.contextWithAnchor}"/>
                    </h:panelGroup>
                    <tr:iterator value="#{ctxt.associatedContexts}" var="a_ctxt">
                        <h:panelGroup styleClass="errorContext">
                            <tr:goLink destination="##{a_ctxt.locator}" rendered="#{a_ctxt.contextWithAnchor}">
                                <nobr><tr:outputText value="#{a_ctxt.objectLabel} #{a_ctxt.locator}" /></nobr>
                            </tr:goLink>
                            <tr:outputText value="#{a_ctxt.objectLabel} #{a_ctxt.locator}" rendered="#{ not a_ctxt.contextWithAnchor}"/>
                        </h:panelGroup>
                    </tr:iterator>
                </tr:iterator>
                <tr:iterator value="#{msg.context.contexts}" var="ctxt" first="3">
                    <h:panelGroup styleClass="errorContext errorContextDetails">
                        <tr:goLink destination="##{ctxt.locator}" rendered="#{ctxt.contextWithAnchor}">
                            <nobr><tr:outputText value="#{ctxt.objectLabel} #{ctxt.locator}" /></nobr>
                        </tr:goLink>
                        <tr:outputText value="#{ctxt.objectLabel} #{ctxt.locator}" rendered="#{ not ctxt.contextWithAnchor}"/>
                    </h:panelGroup>
                    <tr:iterator value="#{ctxt.associatedContexts}" var="a_ctxt">
                        <h:panelGroup styleClass="errorContext errorContextDetails">
                            <tr:goLink destination="##{a_ctxt.locator}" rendered="#{a_ctxt.contextWithAnchor}">
                                <nobr><tr:outputText value="#{a_ctxt.objectLabel} #{a_ctxt.locator}" /></nobr>
                            </tr:goLink>
                            <tr:outputText value="#{a_ctxt.objectLabel} #{a_ctxt.locator}" rendered="#{ not a_ctxt.contextWithAnchor}"/>
                        </h:panelGroup>
                    </tr:iterator>
                </tr:iterator>
                <!-- behavior for these links is in validator.js, listeners are bound dynamically -->
                <tr:goLink styleClass="showErrorContextDetails" rendered="#{msg.context.numberOfContexts > 3}"><tr:outputText value="Show all contexts" /></tr:goLink>
                <tr:goLink styleClass="hideErrorContextDetails errorContextDetails"><tr:outputText value="Hide" /></tr:goLink>
            </tr:column>
        </tr:table>

    </tr:group>

</section>

<!-- HTML View -->
<section class="grid_24">
    <a name="html_view"/>
    <tr:group rendered="#{psiValidatorController.currentPsiReport != null and psiValidatorController.currentPsiReport.syntaxValid}">
        <h2>HTML View</h2>

        <div>
            <tr:outputText value="#{psiValidatorController.currentPsiReport.htmlView}" escape="false"/>
        </div>
    </tr:group>
</section>

</ui:define>
</ui:composition>
