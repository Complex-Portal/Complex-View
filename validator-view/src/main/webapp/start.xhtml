<?xml version="1.0" encoding="UTF-8"?>
<ui:composition
        xmlns:ui="http://java.sun.com/jsf/facelets"
        xmlns:f="http://java.sun.com/jsf/core"
        xmlns:tr="http://myfaces.apache.org/trinidad"
        xmlns:trh="http://myfaces.apache.org/trinidad/html"
        xmlns:h="http://java.sun.com/jsf/html"
        xmlns:c="http://java.sun.com/jstl/core"
        xmlns:ebi="http://ebi.ac.uk/faces/components"

        template="/WEB-INF/facelets/layout/template.xhtml">

<ui:define name="content">
<link rel="stylesheet" href="css/validator.css" type="text/css"/>
<script type="text/javascript" src="javascript/validator.js" />

<trh:tableLayout width="100%">

    <trh:rowLayout>
        <trh:cellFormat>

            <!-- Header -->
            <trh:tableLayout width="100%">
                <trh:rowLayout>
                    <trh:cellFormat halign="left">
                        <tr:goLink destination="http://psidev.sourceforge.net/" styleClass="text-align:left">
                            <tr:image source="images/psi.gif" styleClass="border:0"/>
                        </tr:goLink>
                    </trh:cellFormat>
                    <trh:cellFormat halign="center">
                        <h1><tr:outputText value="The PSI-MI 2.5 Validator" styleClass="text-align:center"/></h1>
                        <trh:tableLayout width="70%" borderWidth="0">
                            <trh:rowLayout>
                                <trh:cellFormat halign="left" valign="middle">
                                    <tr:outputText value="This is the version 2.3 of the PSI-MI Semantic Validator" />
                                    <br/>
                                </trh:cellFormat>
                            </trh:rowLayout>
                        </trh:tableLayout>
                    </trh:cellFormat>
                    <trh:cellFormat halign="right">
                        <tr:goLink destination="http://hupo.org/" styleClass="text-align:right">
                            <tr:image source="images/hupo.gif" styleClass="border:0"/>
                        </tr:goLink>
                    </trh:cellFormat>
                </trh:rowLayout>
            </trh:tableLayout>

        </trh:cellFormat>
    </trh:rowLayout>

</trh:tableLayout>

<tr:spacer height="20" />


<!-- Description -->

<tr:panelHeader text="Overview">

    <tr:group>

        <div style="float:right; padding-left: 20px; padding-top: 20px; background-color: white">

            <tr:panelBox text="Documentation">
                <ul>
                    <li>
                        <tr:commandLink text="News" action="documentation.news"/>
                    </li>
                    <li>
                        <tr:goLink destination="http://www3.interscience.wiley.com/journal/122651438/abstract?CRETRY=1&amp;SRETRY=0" targetFrame="_blank">
                            <tr:outputText value="Publication"/>
                        </tr:goLink>
                    </li>
                    <li>
                        <tr:commandLink text="Local installation" action="documentation.local_installation"/>
                    </li>
                    <li>
                        <tr:goLink destination="http://www.psidev.info/index.php?q=node/336" targetFrame="_blank">
                            <tr:outputText value="Write your own validator"/>
                        </tr:goLink>
                    </li>
                    <li>
                        <tr:goLink destination="http://www.psidev.info/index.php?q=node/278" targetFrame="_blank">
                            <tr:outputText value="MIMIx documentation"/>
                        </tr:goLink>
                    </li>
                    <li>
                        <tr:goLink destination="http://www.imexconsortium.org/" targetFrame="_blank">
                            <tr:outputText value="IMEx website"/>
                        </tr:goLink>
                    </li>
                </ul>
            </tr:panelBox>

        </div>

        <tr:outputText value="The PSI Validator currently validate files in "/>
        <tr:goLink destination="http://www.psidev.info/index.php?q=node/60" targetFrame="_blank">
            <tr:outputText value="PSI-MI XML 2.5"/>
        </tr:goLink>
        <tr:outputText value=" and "/>
        <tr:goLink destination="http://www.psidev.info/index.php?q=node/281" targetFrame="_blank">
            <tr:outputText value="PSI-PAR"/>
        </tr:goLink>
        <tr:outputText value=" format."/>
        <br/>
        <br/>
        <tr:commandLink text="Here" action="documentation.help"/>
        <tr:outputText value=" is a quick user's guide which describes : "/>
        <ul>
            <li>
                <tr:goLink destination="/pages/documentation/help.xhtml#intro">
                    <tr:outputText value="PSI-MI and PSI-PAR validation"/>
                </tr:goLink>
            </li>
            <li>
                <tr:goLink destination="/pages/documentation/help.xhtml#scopes">
                    <tr:outputText value="Validation scopes"/>
                </tr:goLink>
            </li>
            <li>
                <tr:goLink destination="/pages/documentation/help.xhtml#syntax">
                    <tr:outputText value="XML syntax"/>
                </tr:goLink>
            </li>
            <li>
                <tr:goLink destination="/pages/documentation/help.xhtml#controlled_vocabulary">
                    <tr:outputText value="PSI-MI controlled vocabulary"/>
                </tr:goLink>
            </li>
            <li>
                <tr:goLink destination="/pages/documentation/help.xhtml#mimix">
                    <tr:outputText value="MIMIx rules"/>
                </tr:goLink>
            </li>
            <li>
                <tr:goLink destination="/pages/documentation/help.xhtml#imex">
                    <tr:outputText value="IMEx rules"/>
                </tr:goLink>
            </li>
        </ul>
    </tr:group>

</tr:panelHeader>

<tr:spacer height="20" />


<!-- File upload -->

<tr:panelHeader text="PSI-MI XML 2.5 validation">

    <tr:panelGroupLayout layout="vertical">

        <f:facet name="separator">
            <tr:spacer height="15"/>
        </f:facet>

        <trh:tableLayout width="600">

            <trh:rowLayout>
                <trh:cellFormat width="10%">
                    <tr:panelHeader text="File upload"/>
                </trh:cellFormat>
                <trh:cellFormat >
                    <tr:spacer width="60"/>
                </trh:cellFormat>
                <trh:cellFormat width="20%">
                    <tr:panelHeader text="Model and scope selection"/>
                </trh:cellFormat>
                <trh:cellFormat width="70%">
                </trh:cellFormat>
            </trh:rowLayout>
            <trh:rowLayout>
                <trh:cellFormat width="10%" valign="top" halign="left">
                    <!-- source -->
                    <tr:selectOneRadio id="sourceSelector" value="#{psiValidatorController.uploadLocalFile}"
                                       label="Source:"
                                       inlineStyle="width:auto" onclick="displayFileUpload()">
                        <tr:selectItem label="From local file" value="true"/>
                        <tr:selectItem label="From URL" value="false"/>

                    </tr:selectOneRadio>

                    <!-- File/URL input -->
                    <tr:inputFile id="my_input_file" columns="40" label="File:"
                                  value="#{psiValidatorController.psiFile}" styleClass="localFileUpload"/>
                    <tr:inputText id="inputUrl" label="URL:"
                                  columns="50" value="#{psiValidatorController.psiUrl}"
                                  styleClass="urlUpload"/>
                    <tr:panelList>
                       <tr:outputText value="Single XML file"/>
                       <tr:outputText value="ZIP file containing one XML file (if several XML files, only one will be validated)"/>
                    </tr:panelList>
                </trh:cellFormat>
                <trh:cellFormat >
                    <tr:spacer width="70"/>
                </trh:cellFormat>
                <trh:cellFormat width="20%" halign="left" valign="top">
                    <!-- model & scope -->
                    <tr:panelTabbed position="above">
                        <tr:showDetailItem text="Molecular Interactions"
                                           disclosureListener="#{psiValidatorController.validationModelChangedMI}">

                            <tr:panelHorizontalLayout valign="top">
                                <tr:outputText value="Validation scope " />

                                <tr:commandLink action="dialog:miDocumentation" partialSubmit="true"
                                                useWindow="true" windowHeight="400" windowWidth="500">
                                    <tr:image source="images/icon_help.gif"/>
                                </tr:commandLink>

                                <tr:selectOneRadio id="scopeSelector" value="#{psiValidatorController.validationScope}">
                                    <tr:selectItem label="XML Syntax Only" value="SYNTAX"/>
                                    <tr:selectItem label="Controlled Vocabulary Usage" value="CV_ONLY"/>
                                    <tr:selectItem label="MIMIx" shortDesc="Minimum Information about a Molecular Interaction guidelines" value="MIMIX"/>
                                    <tr:selectItem label="IMEx" shortDesc="International Molecular Exchange guidelines" value="IMEX"/>
                                </tr:selectOneRadio>
                            </tr:panelHorizontalLayout>

                        </tr:showDetailItem>

                        <tr:showDetailItem text="Protein Affinity Reagents (beta)"
                                           disclosureListener="#{psiValidatorController.validationModelChangedPAR}" >

                            <tr:panelHorizontalLayout valign="top">
                                <tr:outputText value="Validation scope " />

                                <tr:commandLink action="dialog:parDocumentation" partialSubmit="true"
                                                useWindow="true" windowHeight="400" windowWidth="500">
                                    <tr:image source="images/icon_help.gif"/>
                                </tr:commandLink>

                                <tr:selectOneRadio id="scopeSelector" value="#{psiValidatorController.validationScope}">
                                    <tr:selectItem label="XML Syntax Only" value="SYNTAX"/>
                                    <tr:selectItem label="Controlled Vocabulary Usage" value="CV_ONLY"/>
                                </tr:selectOneRadio>
                            </tr:panelHorizontalLayout>

                        </tr:showDetailItem>
                    </tr:panelTabbed>
                </trh:cellFormat>
                <trh:cellFormat width="70%">
                </trh:cellFormat>
            </trh:rowLayout>
            <trh:rowLayout>
                <trh:cellFormat halign="left" valign="top">
                    <tr:commandButton id="submit_button" text="Validate" action="#{psiValidatorController.validate}"
                                      onclick="document.getElementById('progress_image').style.display = 'block';
                                       document.getElementById('submit_button').disabled=true" inlineStyle="float:left"/>
                    <tr:image id="progress_image" inlineStyle="display:none; float:left" source="/images/wait_red_indicator.gif"/>

                </trh:cellFormat>
            </trh:rowLayout>
        </trh:tableLayout>

    </tr:panelGroupLayout>

</tr:panelHeader>

<tr:messages globalOnly="true"/>

<tr:spacer height="20" />


<!-- Uploaded file report table -->

<tr:panelHeader text="Validation summary"
                rendered="#{psiValidatorController.currentPsiReport != null}">

    <trh:tableLayout>
        <trh:rowLayout>
            <trh:cellFormat>

                <tr:spacer height="20" />

                <trh:tableLayout borderWidth="0"
                                 cellSpacing="5"
                                 cellPadding="0"
                                 halign="left"
                                 width="600"
                                 rendered="#{psiValidatorController.currentPsiReport != null}">
                    <trh:rowLayout>
                        <trh:cellFormat/>
                        <trh:cellFormat>Filename: </trh:cellFormat>
                        <trh:cellFormat>
                            <tr:outputText value="#{psiValidatorController.currentPsiReport.name}"/>
                        </trh:cellFormat>
                        <trh:cellFormat/>
                    </trh:rowLayout>

                    <trh:rowLayout>
                        <trh:cellFormat>
                            <tr:image source="images/icon_success_sml.gif"
                                      rendered="#{psiValidatorController.currentPsiReport.xmlSyntaxValid}"/>
                            <tr:image source="images/icon_error_sml.gif"
                                      rendered="#{psiValidatorController.currentPsiReport.xmlSyntaxInvalid}"/>
                        </trh:cellFormat>
                        <trh:cellFormat>
                            <tr:outputText value="XML Syntax"/>
                        </trh:cellFormat>
                        <trh:cellFormat>
                            <tr:outputText value="#{psiValidatorController.currentPsiReport.xmlSyntaxStatus}"/>
                        </trh:cellFormat>
                        <trh:cellFormat>
                            <tr:panelHorizontalLayout rendered="#{psiValidatorController.currentPsiReport.xmlSyntaxInvalid}">
                                <tr:goLink destination="#xml_report">
                                    <tr:outputText value="Report"/>
                                </tr:goLink>
                                <tr:goLink destination="#html_view" rendered="#{psiValidatorController.currentPsiReport.xmlSyntaxValid}">
                                    <tr:outputText value="HTML View"/>
                                </tr:goLink>
                            </tr:panelHorizontalLayout>
                        </trh:cellFormat>
                    </trh:rowLayout>

                    <!-- TODO It would be desirable to have a row here giving a report on CV usage
                         One could run 2 validators, 1 for CV usage, the other for extra semantic checks
                         and aggregate the errors into the same report.
                    -->

                    <trh:rowLayout rendered="#{psiValidatorController.currentPsiReport.semanticReportAvailable}">
                        <trh:cellFormat>
                            <tr:image source="images/icon_success_sml.gif"
                                      rendered="#{psiValidatorController.currentPsiReport.xmlSemanticValid}"/>
                            <tr:image source="images/icon_warning_sml.gif"
                                      rendered="#{psiValidatorController.currentPsiReport.semanticsStatus == 'warnings'}"/>
                            <tr:image source="images/icon_error_sml.gif"
                                      rendered="#{psiValidatorController.currentPsiReport.xmlSemanticInvalid}"/>
                        </trh:cellFormat>
                        <trh:cellFormat>
                            <tr:outputText value="XML Semantics"/>
                        </trh:cellFormat>
                        <trh:cellFormat>
                            <tr:outputText value="#{psiValidatorController.currentPsiReport.semanticsStatus}"/>
                        </trh:cellFormat>
                        <trh:cellFormat>
                            <tr:goLink destination="#semantics_report" rendered="#{psiValidatorController.currentPsiReport.xmlSemanticInvalid}">
                                <tr:outputText value="Report"/>
                            </tr:goLink>
                        </trh:cellFormat>
                    </trh:rowLayout>
                </trh:tableLayout>

            </trh:cellFormat>
        </trh:rowLayout>

    </trh:tableLayout>

</tr:panelHeader>

<tr:spacer height="20" />


<!-- XML Syntax Validation Report -->

<a name="xml_report"/>
<tr:panelHeader text="XML Syntax Validation Report" rendered="#{psiValidatorController.currentPsiReport.xmlSyntaxInvalid}">

    <tr:table width="800" var="msg" value="#{psiValidatorController.currentPsiReport.xmlSyntaxReport}">
        <tr:column >
            <tr:image source="images/icon_warning_sml.gif" rendered="#{msg.level == 'WARN'}" shortDesc="#{msg.level}"/>
            <tr:image source="images/icon_error_sml.gif" rendered="#{msg.level == 'ERROR'}" shortDesc="#{msg.level}"/>
            <tr:image source="images/icon_error_sml.gif" rendered="#{msg.level == 'FATAL'}" shortDesc="#{msg.level}"/>
        </tr:column>

        <tr:column headerText="Description">
            <tr:outputText value="#{msg.message}" />
        </tr:column>

        <!-- TODO rules only seem to be showing line number 1, always :( -->
        <!-- Build a links to respective object anchor's -->
        <!--<tr:column headerText="Context">-->
        <!--<tr:outputText value="Line #{msg.context.lineNumber}"/>-->
        <!--</tr:column>-->
    </tr:table>

</tr:panelHeader>


<!-- XML Semantic Validation Report (if any messages) -->

<a name="semantics_report"/>
<tr:panelHeader text="PSI MI 2.5 Semantic Validation Report" rendered="#{psiValidatorController.currentPsiReport.semanticReportAvailable}">

    <!-- TODO Display the count of interaction validated -->
    <!--<tr:outputText value="#{psiValidatorController.currentPsiReport.interactionCount} interaction#{psiValidatorController.currentPsiReport.messageCount >1 ? 's' : ''} validated." />-->

    <tr:table width="90%" var="msg" value="#{psiValidatorController.currentPsiReport.validatorMessages}">

        <f:facet name="detailStamp">

            <tr:switcher facetName="#{msg.rule.class.simpleName}" defaultFacet="default" >

                <f:facet name="default">
                    <tr:panelFormLayout>
                        <tr:panelLabelAndMessage label="Type:">
                            <tr:outputText value="User defined rule"/>
                        </tr:panelLabelAndMessage>

                        <tr:panelLabelAndMessage label="Name:">
                            <tr:outputText value="#{msg.rule.name}"/>
                        </tr:panelLabelAndMessage>

                        <tr:panelLabelAndMessage label="Scope:">
                            <tr:outputText value="#{msg.rule.scope}"/>
                        </tr:panelLabelAndMessage>

                        <tr:panelLabelAndMessage label="Description:">
                            <tr:outputText value="#{msg.rule.description}"/>
                        </tr:panelLabelAndMessage>

                        <tr:panelLabelAndMessage label="Tips:" inlineStyle="vertical-align:top;" >
                            <tr:panelList>
                                <tr:iterator value="#{msg.rule.howToFixTips}" var="tip"
                                             rendered="#{msg.rule.howToFixTips != null and not empty msg.rule.howToFixTips}">
                                    <tr:outputText value="#{tip}"/>
                                </tr:iterator>
                            </tr:panelList>
                        </tr:panelLabelAndMessage>
                    </tr:panelFormLayout>
                </f:facet >

                <f:facet name="CvRuleImpl">
                    <tr:panelFormLayout>
                        <tr:panelLabelAndMessage label="Type:">
                            <tr:outputText value="Controlled vocabulary usage rule"/>
                        </tr:panelLabelAndMessage>

                        <tr:panelLabelAndMessage label="Scope:">
                            <tr:outputText value="#{msg.rule.name}"/>
                        </tr:panelLabelAndMessage>

                        <tr:panelLabelAndMessage label="Requirement:">
                            <tr:outputText value="#{msg.rule.requirementLevel}"/>
                        </tr:panelLabelAndMessage>
                    </tr:panelFormLayout>
                </f:facet >

            </tr:switcher>

        </f:facet>

        <tr:column >
            <tr:image source="images/icon_warning_sml.gif" rendered="#{msg.level == 'WARN'}" shortDesc="#{msg.level}"/>
            <tr:image source="images/icon_error_sml.gif" rendered="#{msg.level == 'ERROR'}" shortDesc="#{msg.level}"/>
            <tr:image source="images/icon_error_sml.gif" rendered="#{msg.level == 'FATAL'}" shortDesc="#{msg.level}"/>
        </tr:column>

        <tr:column headerText="Description">
            <tr:outputText value="#{msg.message}" />
        </tr:column>

        <!-- Build a links to respective object anchor's -->
        <tr:column headerText="Context">
            <tr:iterator value="#{msg.context.contexts}" var="ctxt" rows="3" first="0">
                <h:panelGroup styleClass="errorContext">
                    <tr:goLink destination="#e#{ctxt.experimentId}" rendered="#{ctxt.experimentId != -1}">
                        <nobr><tr:outputText value="Experiment ##{ctxt.experimentId}" /></nobr>
                    </tr:goLink>
                    <tr:goLink destination="#ix#{ctxt.interactionId}" rendered="#{ctxt.interactionId != -1}">
                        <nobr><tr:outputText value="Interaction ##{ctxt.interactionId}" /></nobr>
                    </tr:goLink>
                    <tr:goLink destination="#p#{ctxt.participantId}" rendered="#{ctxt.participantId != -1}">
                        <nobr><tr:outputText value="Participant ##{ctxt.participantId}" /></nobr>
                    </tr:goLink>
                    <tr:goLink destination="#i#{ctxt.interactorId}" rendered="#{ctxt.interactorId != -1}">
                        <nobr><tr:outputText value="Interactor ##{ctxt.interactorId}" /></nobr>
                    </tr:goLink>
                    <tr:goLink destination="#f#{ctxt.featureId}" rendered="#{ctxt.featureId != -1}">
                        <nobr><tr:outputText value="Feature ##{ctxt.featureId}" /></nobr>
                    </tr:goLink>
                </h:panelGroup>
            </tr:iterator>
            <tr:iterator value="#{msg.context.contexts}" var="ctxt" first="3">
                <h:panelGroup styleClass="errorContext errorContextDetails">
                    <tr:goLink destination="#e#{ctxt.experimentId}" rendered="#{ctxt.experimentId != -1}">
                        <nobr><tr:outputText value="Experiment ##{ctxt.experimentId}" /></nobr>
                    </tr:goLink>
                    <tr:goLink destination="#ix#{ctxt.interactionId}" rendered="#{ctxt.interactionId != -1}">
                        <nobr><tr:outputText value="Interaction ##{ctxt.interactionId}" /></nobr>
                    </tr:goLink>
                    <tr:goLink destination="#p#{ctxt.participantId}" rendered="#{ctxt.participantId != -1}">
                        <nobr><tr:outputText value="Participant ##{ctxt.participantId}" /></nobr>
                    </tr:goLink>
                    <tr:goLink destination="#i#{ctxt.interactorId}" rendered="#{ctxt.interactorId != -1}">
                        <nobr><tr:outputText value="Interactor ##{ctxt.interactorId}" /></nobr>
                    </tr:goLink>
                    <tr:goLink destination="#f#{ctxt.featureId}" rendered="#{ctxt.featureId != -1}">
                        <nobr><tr:outputText value="Feature ##{ctxt.featureId}" /></nobr>
                    </tr:goLink>
                </h:panelGroup>
            </tr:iterator>
            <!-- behavior for these links is in validator.js, listeners are bound dynamically -->
            <tr:goLink styleClass="showErrorContextDetails" rendered="#{msg.context.numberOfContexts > 3}"><tr:outputText value="Show all contexts" /></tr:goLink>
            <tr:goLink styleClass="hideErrorContextDetails errorContextDetails"><tr:outputText value="Hide" /></tr:goLink>
        </tr:column>
    </tr:table>

</tr:panelHeader>

<tr:spacer height="20" />


<!-- HTML View -->
<a name="html_view"/>
<tr:panelHeader text="HTML View"
                rendered="#{psiValidatorController.currentPsiReport != null and psiValidatorController.currentPsiReport.xmlSyntaxValid}">

    <div>
        <tr:outputText value="#{psiValidatorController.currentPsiReport.htmlView}" escape="false"/>
    </div>

</tr:panelHeader>

</ui:define>

</ui:composition>