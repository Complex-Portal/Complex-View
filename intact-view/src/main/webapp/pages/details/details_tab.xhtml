<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:c="http://java.sun.com/jstl/core"
                xmlns:fn="http://java.sun.com/jsp/jstl/functions"
                xmlns:p="http://primefaces.prime.com.tr/ui"

                xmlns:sf="http://www.ebi.ac.uk/faces/site"
                xmlns:iv="http://java.sun.com/jsf/composite/components/intactview"
                xmlns:iam="http://intact.ebi.ac.uk/miscel"

                xmlns:iav="http://intact.ebi.ac.uk/view"
                xmlns:iaf="http://intact.ebi.ac.uk/functions"
                xmlns:iax="http://intact.ebi.ac.uk/extlinks">

<h:panelGroup id="experimentPanel" rendered="#{detailsBean.experiment != null}">

<ui:param name="experiment" value="#{detailsBean.experiment}"/>
<!-- TODO Following statement would be harsh on the database if the experiment has a large amount of interactions !! -->
<ui:param name="interactionCount" value="#{fn:length(experiment.interactions)}"/>

<h2>Experiment (#{interactionCount} interaction#{interactionCount > 1 ? 's' : ''})</h2>

<h:panelGroup>

    <iv:panelLabelAndMessage label="Accession:" labelStyleClass="textLabel">
        <h:outputText value="#{experiment.ac}"/>
    </iv:panelLabelAndMessage>

    <iv:panelLabelAndMessage label="Name:" labelStyleClass="textLabel">
        <h:outputText value="#{experiment.shortLabel}"/>
    </iv:panelLabelAndMessage>

    <iv:panelLabelAndMessage label="Host organism:" labelStyleClass="textLabel">
        <iv:biosourcePopup bioSource="#{experiment.bioSource}"/>
    </iv:panelLabelAndMessage>

    <iv:panelLabelAndMessage label="Interaction Detection Method:" labelStyleClass="textLabel">
        <iv:cvPopup cv="#{experiment.cvInteraction}"/>
    </iv:panelLabelAndMessage>

    <iv:panelLabelAndMessage label="Participant Identification Method:" labelStyleClass="textLabel">
        <iv:cvPopup cv="#{experiment.cvIdentification}"/>
    </iv:panelLabelAndMessage>

    <table border="0">
        <tr>
            <td style="font-weight:bold; vertical-align:top; text-align:right;">Cross References:</td>
            <td><iv:xrefTable xrefs="#{experiment.xrefs}"/></td>
        </tr>
        <tr>
            <td style="font-weight:bold; vertical-align:top; text-align:right;">Annotations:</td>
            <td><iv:annotationTable annotations="#{experiment.annotations}"/></td>
        </tr>
    </table>

</h:panelGroup>


<ui:param name="publication" value="#{experiment.publication}"/>
<ui:param name="pmid" value="#{iaf:getPubmedId(experiment)}"/>

<h2>Publication</h2>

<table id="publicationTable" width="100%">
    <tr>
        <td width="80%">

            <iv:panelLabelAndMessage label="Author List:" labelStyleClass="textLabel">
                <h:outputText value="#{detailsBean.authorList}"/>
            </iv:panelLabelAndMessage>

            <iv:panelLabelAndMessage label="Title:" labelStyleClass="textLabel">
                <h:outputText value="#{(experiment.fullName == null ? '-' : experiment.fullName )}"/>
            </iv:panelLabelAndMessage>

            <iv:panelLabelAndMessage label="Journal:" labelStyleClass="textLabel">
                <h:outputText value="#{detailsBean.journal}"/>
            </iv:panelLabelAndMessage>

            <iv:panelLabelAndMessage label="Year of Publication:" labelStyleClass="textLabel">
                <h:outputText value="#{detailsBean.publicationYear}"/>
            </iv:panelLabelAndMessage>

            <iv:panelLabelAndMessage label="PubMed Id:" visible="#{pmid != null}" labelStyleClass="textLabel">
                <h:outputText value="#{pmid}"/>
            </iv:panelLabelAndMessage>

            <iv:panelLabelAndMessage label="Cross References:" visible="#{not empty publication.xrefs}"
                                     labelStyleClass="textLabel">
                <iv:xrefTable xrefs="#{publication.xrefs}"/>
            </iv:panelLabelAndMessage>

            <iv:panelLabelAndMessage label="Annotations:" visible="#{not empty publication.annotations}"
                                     labelStyleClass="textLabel">
                <iv:annotationTable annotations="#{publication.annotations}"/>
            </iv:panelLabelAndMessage>

        </td>

        <td width="20%" style="text-align: right; vertical-align: top;">

            <p:panel id="publicationLinks" header="Links">
                <h:commandLink value="Show all interactions" action="#{searchBean.doBinarySearchAction}">
                    <f:setPropertyActionListener value="pubid:#{pmid}" target="#{userQuery.searchQuery}"/>
                    <f:setPropertyActionListener value="2" target="#{contextController.activeTabIndex}"/>
                </h:commandLink>
            </p:panel>

        </td>
    </tr>
</table>


<ui:param name="interaction" value="#{detailsBean.interaction}"/>

<h:panelGroup id="interactionPanel" rendered="#{interaction != null}">
    <h2>Interaction</h2>

    <table width="100%">
        <tr>
            <td width="80%">
                <iv:panelLabelAndMessage label="Accession:" labelStyleClass="textLabel">
                    <h:outputText value="#{interaction.ac}"/>
                </iv:panelLabelAndMessage>

                <iv:panelLabelAndMessage label="Name:" labelStyleClass="textLabel">
                    <h:outputText value="#{interaction.shortLabel}"/>
                </iv:panelLabelAndMessage>

                <iv:panelLabelAndMessage label="Description:" labelStyleClass="textLabel">
                    <h:outputText value="#{(interaction.fullName == null ? '-' : interaction.fullName )}"/>
                </iv:panelLabelAndMessage>

                <iv:panelLabelAndMessage label="Type:" labelStyleClass="textLabel">
                    <iv:cvPopup cv="#{interaction.cvInteractionType}"/>
                </iv:panelLabelAndMessage>

                <table border="0">
                    <h:panelGroup rendered="#{not empty interaction.xrefs}">
                        <tr>
                            <td style="font-weight:bold; vertical-align:top; text-align:right;">Cross References:</td>
                            <td><iv:xrefTable xrefs="#{interaction.xrefs}"/></td>
                        </tr>
                    </h:panelGroup>

                    <h:panelGroup rendered="#{not empty interaction.annotations}">
                        <tr>
                            <td style="font-weight:bold; vertical-align:top; text-align:right;">Annotations:</td>
                            <td><iv:annotationTable annotations="#{interaction.annotations}"/></td>
                        </tr>
                    </h:panelGroup>
                </table>
            </td>

            <td style="text-align: right; vertical-align: top;" width="20%">

                <p:panel id="interactionLinks" header="Links">

                    <h:commandLink value="Find similar interactions" action="browse.complex"
                                   onclick="document.getElementById('progress_image').style.display = 'block'; document.getElementById('progress_text').style.display = 'block';"/>

                    <br/>

                    <p:panel style="border: 0px">
                        <h:graphicImage id="progress_image" alt="progress" style="display:none;"
                                        url="/images/wait_red_indicator.gif"/>
                        <h:outputText id="progress_text" style="display:none;"
                                      value="This search may take up to a few minutes when the number of participant is high. Please be patient."/>
                    </p:panel>
                </p:panel>

            </td>
        </tr>
    </table>

</h:panelGroup>


<ui:param name="participantCount" value="#{fn:length(interaction.components)}"/>
<ui:param name="text" value="s (#{participantCount})"/>

<h:panelGroup rendered="#{interaction != null}">

<h2>Participant#{(participantCount > 1 ? text : '')}</h2>

<iv:cvLazyDialog dialogVar="cvInfoDialog"/>

<p:dataTable var="participant" value="#{interaction.components}" paginator="false" dynamic="false" lazy="false">

    <ui:param name="interactor" value="#{participant.interactor}"/>

    <p:column>
        <f:facet name="header">
            <h:outputText value="Name"/>
        </f:facet>
        <h:outputText value="#{interactor.shortLabel}"/>
    </p:column>

    <p:column>
        <f:facet name="header">
            <h:outputText value="Links"/>
        </f:facet>
        <iv:dbInteractorLinkLogos interactor="#{interactor}"/>
    </p:column>

    <p:column>
        <f:facet name="header">
            <h:outputText value="Primary Identifier"/>
        </f:facet>
        <ui:repeat var="xref" value="#{iaf:getIdentityXrefs(interactor)}" varStatus="rowStatus">
            <h:outputLink value="#{iaf:calculateDbXrefUrl(xref.cvDatabase, xref.primaryId)}" target="_blank">
                <h:outputText value="#{xref.primaryId}"/>
            </h:outputLink>
        </ui:repeat>
    </p:column>

    <p:column>
        <f:facet name="header">
            <h:outputText value="Aliases"/>
        </f:facet>
        <iam:collapsibleIterator id="csd_aliases_#{status.index}"
                                 disclosed="false"
                                 value="#{interactor.aliases}"
                                 maxShown="5">
            <h:outputText value="#{item.name}" shortDesc="#{item.cvAliasType.shortLabel}"/>
        </iam:collapsibleIterator>
    </p:column>

    <p:column>
        <f:facet name="header">
            <h:outputText value="Description"/>
        </f:facet>
        <h:outputText value="#{interactor.fullName}"/>
    </p:column>

    <p:column>
        <f:facet name="header">
            <h:outputText value="Species"/>
        </f:facet>
        <iv:biosourcePopup bioSource="#{interactor.bioSource}" visible="#{interactor.bioSource != null}"/>
        <h:outputText value="-" rendered="#{interactor.bioSource == null}"/>
    </p:column>

    <p:column>
        <f:facet name="header">
            <h:outputText value="Expression system"/>
        </f:facet>
        <iv:biosourcePopup bioSource="#{participant.expressedIn}" visible="#{participant.expressedIn != null}"/>
        <h:outputText value="-" rendered="#{participant.expressedIn == null}"/>
    </p:column>

    <p:column>
        <f:facet name="header">
            <h:outputText value="Experimental role"/>
        </f:facet>
        <iv:cvLazyPopup cvIdentifier="#{participant.cvExperimentalRole.identifier}" dialogVar="cvInfoDialog"
                        text="#{participant.cvExperimentalRole.shortLabel}"
                        cvClassName="uk.ac.ebi.intact.model.CvExperimentalRole"/>
    </p:column>

    <p:column>
        <f:facet name="header">
            <h:outputText value="Biological role"/>
        </f:facet>
        <iv:cvLazyPopup cvIdentifier="#{participant.cvBiologicalRole.identifier}" dialogVar="cvInfoDialog"
                        text="#{participant.cvBiologicalRole.shortLabel}"
                        cvClassName="uk.ac.ebi.intact.model.CvBiologicalRole"/>
    </p:column>

    <p:column>
        <f:facet name="header">
            <h:outputText value="Interactor type"/>
        </f:facet>
        <iv:cvLazyPopup cvIdentifier="#{interactor.cvInteractorType.identifier}" dialogVar="cvInfoDialog"
                        text="#{interactor.cvInteractorType.shortLabel}"
                        cvClassName="uk.ac.ebi.intact.model.CvInteractorType"/>
    </p:column>

    <p:column>

        <f:facet name="header">
            <h:outputText value="More..."/>
        </f:facet>

        <ui:param name="annotationCount"
                  value="#{fn:length(participant.xrefs) + fn:length(participant.annotations) + fn:length(participant.aliases)}"/>
        <ui:param name="parameterCount" value="#{fn:length(participant.parameters)}"/>
        <ui:param name="domainCount" value="#{fn:length(participant.bindingDomains)}"/>

        <div class="extra" style="border: 0px; width:100px; ">
            <div class="#{annotationCount>0 ? 'ia-annotation' : 'ia-legend-gray'}" style="width:10px; display: inline; border: 1px solid gray;" align="center">
                <p:commandLink id="participantLink" type="button" onclick="participantDlg.show();" update="participantDetailsPanel" rendered="#{annotationCount gt 0}">
                    <h:outputText value="A" style="color: white;"/>
                </p:commandLink>
                <h:outputText value="A" rendered="#{annotationCount eq 0}" />
            </div>
            <div class="#{parameterCount>0 ? 'ia-parameter' : 'ia-legend-gray'}" style="width:10px; display: inline; border: 1px solid gray;" align="center">
                <p:commandLink id="participantLink" type="button" onclick="participantDlg.show();" update="participantDetailsPanel" rendered="#{parameterCount gt 0}">
                    <h:outputText value="P" style="color: white;"/>
                </p:commandLink>
                <h:outputText value="P" rendered="#{parameterCount eq 0}" />
            </div>
            <div class="#{domainCount>0 ? 'ia-feature' : 'ia-legend-gray'}" style="width:10px; display: inline; border: 1px solid gray;" align="center">
                <p:commandLink id="participantLink" type="button" onclick="participantDlg.show();" update="participantDetailsPanel" rendered="#{domainCount gt 0}">
                    <h:outputText value="F" style="color: white;"/>
                </p:commandLink>
                <h:outputText value="F" rendered="#{domainCount eq 0}" />
            </div>
            <div class="#{participant.stoichiometry>0 ? 'ia-stoichiometry' : 'ia-legend-gray'}" style="width:10px; display: inline; border: 1px solid gray;" align="center">
                <p:commandLink id="participantLink" type="button" onclick="participantDlg.show();" update="participantDetailsPanel" rendered="#{participant.stoichiometry gt 0}">
                    <h:outputText value="S" style="color: white;"/>
                </p:commandLink>
                <h:outputText value="S" rendered="#{participant.stoichiometry eq 0}" />
            </div>

        </div>

    </p:column>

</p:dataTable>

<br/>

    <div class="legend" style="margin-top: 5px; margin-left: 15px;" align="right">
        <b>Legend:</b>
        <div class="ia-annotation" style="display: inline; border: 1px solid gray;">A</div>Annotation &#160;&#160;
        <div class="ia-parameter" style="display: inline; border: 1px solid gray;">P</div>Experimental Parameter &#160;&#160;
        <div class="ia-stoichiometry" style="display: inline; border: 1px solid gray;">S</div>Stoichiometry &#160;&#160;
        <div class="ia-feature" style="display: inline; border: 1px solid gray;">F</div>Experimental Feature
    </div>

    <p:dialog header="Participant: #{cc.attrs.participant.interactor.fullName}"
              widgetVar="participantDlg" height="400" width="750" fixedCenter="true"
              constrainToViewport="true" modal="false">

        <h:panelGroup id="participantDetailsPanel">

        <h3>Participant: #{participant.ac}</h3>

        <!--<tr:panelFormLayout inlineStyle="width:100%">-->

            <iv:panelLabelAndMessage label="Accession:" labelStyle="font-weight:bold;">
                <h:outputText value="#{participant.ac}"/>
            </iv:panelLabelAndMessage>

            <iv:panelLabelAndMessage label="Name:" labelStyle="font-weight:bold;">
                <h:outputText value="#{participant.interactor.shortLabel}"/>
            </iv:panelLabelAndMessage>

            <iv:panelLabelAndMessage label="Primary identifier:" labelStyle="font-weight:bold;">
                <ui:repeat var="xref" value="#{iaf:getIdentityXrefs(participant.interactor)}">
                    <h:outputLink value="#{iaf:calculateDbXrefUrl(xref.cvDatabase, xref.primaryId)}" target="_blank">
                        <h:outputText value="#{xref.primaryId}"/>
                        </h:outputLink>
                </ui:repeat>
            </iv:panelLabelAndMessage>

            <iv:panelLabelAndMessage label="Molecule type:" labelStyle="font-weight:bold;">
                    <h:outputText value="#{participant.interactor.cvInteractorType.shortLabel}"/>
            </iv:panelLabelAndMessage>

            <iv:panelLabelAndMessage label="Stoichiometry:" labelStyle="font-weight:bold;" visible="#{participant.stoichiometry > 0}">
                <h:outputText value="#{participant.stoichiometry}"/>
            </iv:panelLabelAndMessage>

        <!--</tr:panelFormLayout>-->

        <!--<tr:panelFormLayout inlineStyle="width:100%;">-->

            <!--<iv:spacer height="10" rendered="#{not empty participant.xrefs}"/>-->
            <iv:panelLabelAndMessage label="Cross References:" visible="#{not empty participant.xrefs}"
                                     labelStyle="font-weight:bold;">
                 <iv:xrefTable xrefs="#{participant.xrefs}" />
            </iv:panelLabelAndMessage>

            <!--<tr:spacer height="10" rendered="#{not empty participant.annotations}"/>-->
            <iv:panelLabelAndMessage label="Annotations:" visible="#{not empty participant.annotations}"
                                     labelStyle="font-weight:bold;">
                <iv:annotationTable annotations="#{participant.annotations}" />
            </iv:panelLabelAndMessage>

            <!--<tr:spacer height="10" rendered="#{not empty participant.bindingDomains}"/>-->
            <iv:panelLabelAndMessage label="Experimental features:" visible="#{not empty participant.bindingDomains}"
                                     labelStyle="font-weight:bold;">

                <ui:decorate template="/pages/details/bindingDomains.xhtml">
                    <ui:param name="bindingDomains" value="#{participant.bindingDomains}"/>
                </ui:decorate>
            </iv:panelLabelAndMessage>

            <!--<tr:spacer height="10" rendered="#{not empty participant.parameters}"/>-->
            <iv:panelLabelAndMessage label="Experimental Parameters:" visible="#{not empty participant.parameters}"
                                     labelStyle="font-weight:bold;">

                <ui:decorate template="/pages/details/parameters.xhtml">
                    <ui:param name="parameters" value="#{participant.parameters}"/>
                </ui:decorate>
            </iv:panelLabelAndMessage>

        <!--</tr:panelFormLayout>-->
        </h:panelGroup>

    </p:dialog>


    <h:panelGroup rendered="#{detailsBean.featuresAvailable}">
        <h2>Graphical Representation of Experimental Features</h2>
        <iv:interactionRepresentation url="/intact/json?ac=#{interaction.ac}" />
    </h:panelGroup>

</h:panelGroup>

</h:panelGroup>

</ui:composition>
