<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:c="http://java.sun.com/jsp/jstl/core"
                xmlns:p="http://primefaces.prime.com.tr/ui"
                xmlns:ia="http://java.sun.com/jsf/composite/components/intact"

                template="/main_template.xhtml">

    <ui:define name="topNavigation">
        <ui:include src="/shared/top_navigation_bar.xhtml">
            <ui:param name="selected" value="curate"/>
        </ui:include>
    </ui:define>

    <ui:define name="topTitle">
        <h:panelGroup rendered="#{publicationController.publication != null}">
            <h:link outcome="/curate/publication" value="#{publicationController.firstAuthor} et al (#{publicationController.year})" rendered="#{publicationController.firstAuthor != null}"/>

            <h:panelGroup rendered="#{publicationController.publication.shortLabel != null}">
                (&#160;<h:outputText value="#{publicationController.publication.shortLabel}"/> )
            </h:panelGroup>
        </h:panelGroup>
    </ui:define>

    <ui:define name="top">
        <h:panelGroup rendered="#{annotatedObjectController.annotatedObject != null}">
            <h:panelGroup id="topSavePanel" style="float: right">
                <p:commandButton type="button" id="topSaveButton" value="Save" onclick="save(); return false" />
                <!--<p:commandButton value="save 2" actionListener="#{annotatedObjectController.doSave}" ajax="false" />-->

                <h:panelGroup rendered="#{annotatedObjectController.lastSaved != null}" style="color: #AAAAAA">
                    <h:outputText value=" Last Saved: " />
                    <h:outputText value="#{annotatedObjectController.lastSaved}">
                        <f:convertDateTime pattern="HH:mm (z)"/>
                    </h:outputText>
                </h:panelGroup>
            </h:panelGroup>
        </h:panelGroup>
    </ui:define>

    <ui:define name="menuBar">
        <p:menubar id="menubar">
            <ui:insert name="menuBarContextual"/>
            <p:submenu label="Main">
                <p:submenu>
                <f:facet name="label">
                    <p:menuitem value="New" icon="/resources/images/new.png"/>
                </f:facet>
                <p:menuitem value="Publication" onclick="newPublicationDlg.show();" helpText="ALT+N"/>
                <p:menuitem value="Interactor..." onclick="newInteractorDialog.show(); "/>
                <p:menuitem value="CV Object..." onclick="newCvObjectDialog.show(); "/>
                <p:menuitem value="Organism" action="#{bioSourceController.newOrganism}" ajax="false"/>
            </p:submenu>
                <!--<p:menuitem value="New" onclick="newPublicationDlg.show();"/>-->
                <p:menuitem value="Open by PMID..." onclick="openByPmidDlg.show(); " helpText="ALT+O" icon="/resources/images/open.png"/>
                <p:menuitem value="Save" oncomplete="save()" helpText="ALT+S" icon="/resources/images/save.gif"
                        rendered="#{annotatedObjectController.annotatedObject != null}"/>
                <!--<p:menuitem value="Save &amp; Close" onclick="save()" ajax="false"-->
                            <!--rendered="#{annotatedObjectController.annotatedObject != null}"/>-->
            </p:submenu>

            <p:submenu label="Tools" rendered="#{curatorContextController.intactObjectSimpleName(annotatedObjectController.annotatedObject) != 'Publication'}">
                <p:menuitem value="Clone #{curatorContextController.intactObjectSimpleName(annotatedObjectController.annotatedObject)}" action="#{annotatedObjectController.clone}" ajax="false"
                        onclick="cloningDialog.show()" oncomplete="cloningDialog.hide()"/>
                <ui:insert name="toolsContextual"/>
            </p:submenu>

            <p:submenu label="Reviewer" rendered="#{userSessionController.hasRole('REVIEWER')}">
                <p:menuitem value="Accept publication" actionListener="#{publicationController.acceptPublication}"
                        rendered="#{annotatedObjectController.annotatedObject != null and annotatedObjectController.annotatedObject.class.simpleName == 'Publication'}"
                        update="centralUnit,topSection"/>
                <p:menuitem value="Accept experiment" actionListener="#{experimentController.acceptExperiment}"
                        rendered="#{annotatedObjectController.annotatedObject != null and annotatedObjectController.annotatedObject.class.simpleName == 'Experiment'}"
                        update="centralUnit,topSection"/>
            </p:submenu>

            <p:submenu label="Debug" rendered="#{facesContext.application.projectStage == 'Development'}">
                <p:menuitem value="Changes" action="/curate/debug/changes" ajax="false"/>
                <p:menuitem value="Refresh" update="contentSection"/>
                <p:menuitem value="Revert" actionListener="#{annotatedObjectController.doRevertChanges}" update="centralUnit,topSection"/>
            </p:submenu>
        </p:menubar>
    </ui:define>

    <ui:define name="content">
        <p:hotkey bind="alt+n" oncomplete="newPublicationDlg.show()"/>
        <p:hotkey bind="alt+o" oncomplete="openByPmidDlg.show()"/>
        <p:hotkey bind="alt+s" oncomplete="save(); return false"/>

        <p:remoteCommand name="markAsUnsaved" update="messagesComponent,changesPanel,unsavedChangesInfo"
                                 actionListener="#{annotatedObjectController.changed(null)}"/>

        <ia:loadingDialog widgetVar="loadDialog"/>

        <div style="width:100%;">
            <h:panelGroup rendered="#{annotatedObjectController.annotatedObject != null}">
                <h:panelGroup id="unsavedChangesInfo" style="float: right; margin-right: 40px">
                    <ui:insert name="curateTopRight">
                        <h:panelGroup rendered="#{curatorContextController.allChanges.size() gt 0}">
                            <ia:panelMessage level="warn" showIcon="true">
                                <p:commandLink value="#{curatorContextController.allChanges.size()} unsaved changes"
                                               update="unsavedTable"
                                               onclick="unsavedChangesDialog.show()"/>
                            </ia:panelMessage>
                        </h:panelGroup>


                        <ui:include src="dialog_unsaved_changes.xhtml"/>
                    </ui:insert>
                </h:panelGroup>

                <ui:insert name="breadcrumbs"/>

            </h:panelGroup>

            <br/><br/>

            <ui:insert name="curateContent"/>

            <p:outputPanel id="changesPanel">

            <h:panelGroup rendered="#{annotatedObjectController.unsavedChanges}">

                <!--<h:outputScript>-->
                    <!--YAHOO.util.Event.addListener(window, 'beforeunload', function(e) {-->
                    <!--//if (! confirm('You have unsaved changes, leave this page? You can save the data later')) {-->
                    <!--//   YAHOO.util.Event.stopEvent(e);-->
                    <!--//}-->

                      <!--autoSave();-->
                    <!--});-->
                <!--</h:outputScript>-->

                <!-- Interactor -->
                   <!--<p:confirmDialog message="Are you sure you want to leave without saving?" widgetVar="unsavedWarnDialog">-->
                       <!--<p:commandButton value="Save Now" onclick="save(); return false; " oncomplete="unsavedWarnDialog.hide()"/>-->
                       <!--<p:commandButton value="I will save it later" type="button" onclick="unsavedWarnDialog.hide()"/>-->
                       <!--<p:commandButton value="Discard changes" actionListener="#{annotatedObjectController.doRevertChanges}"-->
                                        <!--update="centralUnit,topSection,growl,messagesComponent" oncomplete="unsavedWarnDialog.hide()"/>-->
                   <!--</p:confirmDialog>-->


            <p>&#160;</p>

            <div class="intact-notSavedPanel">
                    Changes not yet saved &#160;
                <p:commandButton type="button" id="unsavedSaveButton"
                                 style="opacity: 1.0; font-weight: bold"
                                 value="Save" onclick="save(); return false"/>
                &#160;-&#160;
                <p:commandLink id="unsavedRevertLink" value="Revert" style="opacity: 1.0; font-weight: bold"
                               rendered="#{annotatedObjectController.annotatedObject.ac != null}"
                               process="@this"
                               actionListener="#{annotatedObjectController.doRevertChanges}"
                               update="centralUnit,topSection,messagesComponent"
                               onclick="revertDialog.show()" oncomplete="revertDialog.hide()"/>

                <p:commandLink id="unsavedCancelLink" value="Cancel" style="opacity: 1.0; font-weight: bold"
                               rendered="#{annotatedObjectController.annotatedObject.ac == null}"
                               immediate="true"
                               actionListener="#{annotatedObjectController.doCancelEdition}"
                               update="centralUnit,topSection,messagesComponent"
                               onclick="revertDialog.show()" oncomplete="revertDialog.hide(); history.back()"/>
            </div>

            </h:panelGroup>
        </p:outputPanel>
        </div>

        <p:remoteCommand name="save" actionListener="#{annotatedObjectController.doSave}"
                         update="centralUnit,topSection,messagesComponent"
                        onstart="saveDialog.show(); var input = document.getElementById('topSaveButton'); input.disabled = true; input.value = 'Saving...'"
                        onerror="alert('Error: '+error+' '+status)"
                        oncomplete="saveDialog.hide(); var input = document.getElementById('topSaveButton'); input.disabled = false; input.value = 'Save'"/>

        <p:remoteCommand name="autoSave" actionListener="#{annotatedObjectController.doSave}" async="true"/>


        <!-- CvObject -->
    <p:dialog header="New CV Object" width="400" widgetVar="newCvObjectDialog" visible="false" draggable="false"
              modal="true" position="center" resizable="false">
         <ia:panelDialogLayout>
             <f:facet name="buttonBar">
                 <p:commandButton value="Create" action="#{cvObjectController.newCvObject}" ajax="false"/>
             </f:facet>

                <h:outputLabel for="cvType" value="Type: "/>
                <h:selectOneMenu id="cvType" value="#{cvObjectController.newCvObjectType}">
                    <f:selectItem itemLabel="-- Select --" noSelectionOption="true"/>
                    <f:selectItem itemLabel="Alias type" itemValue="uk.ac.ebi.intact.model.CvAliasType"/>
                    <f:selectItem itemLabel="Biological role" itemValue="uk.ac.ebi.intact.model.CvBiologicalRole"/>
                    <f:selectItem itemLabel="Cell type" itemValue="uk.ac.ebi.intact.model.CvCellType"/>
                    <f:selectItem itemLabel="Confidence type" itemValue="uk.ac.ebi.intact.model.CvConfidenceType"/>
                    <f:selectItem itemLabel="Database" itemValue="uk.ac.ebi.intact.model.CvDatabase"/>
                    <f:selectItem itemLabel="Experimental role" itemValue="uk.ac.ebi.intact.model.CvExperimentalRole"/>
                    <f:selectItem itemLabel="Experimental preparation" itemValue="uk.ac.ebi.intact.model.CvExperimentalPreparation"/>
                    <f:selectItem itemLabel="Fuzzy type" itemValue="uk.ac.ebi.intact.model.CvFuzzyType"/>
                    <f:selectItem itemLabel="Parameter type" itemValue="uk.ac.ebi.intact.model.CvParameterType"/>
                    <f:selectItem itemLabel="Parameter unit" itemValue="uk.ac.ebi.intact.model.CvParameterUnit"/>
                    <f:selectItem itemLabel="Tissue" itemValue="uk.ac.ebi.intact.model.CvTissue"/>
                    <f:selectItem itemLabel="Topic" itemValue="uk.ac.ebi.intact.model.CvTopic"/>
                    <f:selectItem itemLabel="Xref qualifier" itemValue="uk.ac.ebi.intact.model.CvXrefQualifier"/>
                </h:selectOneMenu>

        </ia:panelDialogLayout>
    </p:dialog>

    <!-- Interactor -->
    <p:dialog header="New Interactor" width="400" widgetVar="newInteractorDialog" visible="false" draggable="false"
              modal="true" position="center" resizable="false">
         <ia:panelDialogLayout>
             <f:facet name="buttonBar">
                 <p:commandButton value="Create" action="#{interactorController.newInteractor}" ajax="false"/>
             </f:facet>
             
                <h:panelGrid columns="2">
                    <h:outputLabel for="interactorTxt" value="Type: "/>
                    <ia:inputCvObject id="interactorTxt" value="#{interactorController.newInteractorType}"
                                                      selectItems="#{cvObjectService.interactorTypeSelectItems}"
                                                      cvIdentifier="MI:0313"/>
                </h:panelGrid>

         </ia:panelDialogLayout>
    </p:dialog>

    </ui:define>

    <ui:define name="dialogs">
        <ui:include src="menu_dialogs.xhtml"/>

        <ia:loadingDialog widgetVar="saveDialog" message="Saving #{curatorContextController.intactObjectSimpleName(annotatedObjectController.annotatedObject)}..."/>
        <ia:loadingDialog widgetVar="revertDialog" message="Reverting changes..."/>
        <ia:loadingDialog widgetVar="cloningDialog" message="Cloning object..."/>
    </ui:define>

</ui:composition>