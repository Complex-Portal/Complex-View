<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:c="http://java.sun.com/jstl/core"
                xmlns:fn="http://java.sun.com/jsp/jstl/functions"
                xmlns:p="http://primefaces.prime.com.tr/ui"
                xmlns:ia="http://java.sun.com/jsf/composite/components/intact"

                template="/curate/curate_template.xhtml">


    <ui:define name="curateContent">
        <p:hotkey bind="alt+s" actionListener="#{publicationController.doSave}"
                  update="publicationDetails,northUnit,growl,changesPanel"/>

        <f:metadata>
            <f:viewParam name="ac" value="#{publicationController.ac}"/>
            <f:event type="preRenderView" listener="#{publicationController.loadData}"/>
        </f:metadata>

        <h:panelGroup rendered="#{publicationController.publication == null}">
            No publication loaded!
        </h:panelGroup>

        <h:panelGroup rendered="#{publicationController.publication != null}">

            <h2>Publication Details</h2>

            <p:outputPanel id="publicationDetails">

                <p:outputPanel id="basic">

                    <p:outputPanel id="acceptedPanel" rendered="#{not empty publicationController.acceptedMessage}">
                        <ia:panelMessage level="info">
                            This publication is <b>accepted</b>. #{publicationController.acceptedMessage}
                        </ia:panelMessage>
                    </p:outputPanel>

                    <p:outputPanel id="onHoldWarningPanel" rendered="#{not empty publicationController.onHold}">
                        <ia:panelMessage level="warn">
                            This publication is <b>on-hold</b>. Reason: #{publicationController.onHold}
                            &#160;&#160;&#160;
                            <p:commandButton value="Clear"
                                             onclick="document.getElementById('basicInfoPanel:onHoldTxt').value = ''"
                                             update="onHoldWarningPanel,annotationsPanel"/>
                        </ia:panelMessage>
                    </p:outputPanel>

                    <ia:panelFormLayout id="basicInfoPanel" columns="1">
                        <h:outputLabel value="AC: " for="acTxt"/>
                        <h:inputText id="acTxt" value="#{publicationController.publication.ac}"
                                     size="10" disabled="true"/>

                        <h:outputLabel value="Identifier: " for="idTxt"/>
                        <h:panelGroup>
                            <h:inputText id="idTxt" value="#{publicationController.publication.shortLabel}"
                                         size="10" required="true" onkeyup="enableAutocomplete()">
                                <f:ajax event="valueChange" render=":editorForm:changesPanel"
                                        listener="#{publicationController.changed}"/>
                            </h:inputText>

                            <p:remoteCommand name="enableAutocomplete" update="autocompleteBtn" async="true">
                                <f:setPropertyActionListener value="#{true}"
                                                             target="#{requestScope.autocompleteEnabled}"/>
                            </p:remoteCommand>

                            <p:commandButton id="autocompleteBtn" value="Auto-complete"
                                             disabled="#{not requestScope.autocompleteEnabled}"
                                             actionListener="#{publicationController.doFormAutocomplete}" async="true"
                                             update="publicationDetails,northUnit,growl">
                                <p:confirmDialog yesLabel="Auto-complete" noLabel="Not now" width="300px"
                                                 draggable="false"
                                                 message="Auto-completing an existing publication will update its cross references and annotations. Are you sure?"
                                                 header="Auto-complete confirmation" severity="warn"/>
                            </p:commandButton>
                        </h:panelGroup>

                        <h:outputLabel value="Title: " for="titleTxt"/>
                        <h:inputText id="titleTxt" value="#{publicationController.publication.fullName}" size="80">
                            <f:ajax event="valueChange" render=":editorForm:changesPanel"
                                    listener="#{publicationController.changed}"/>
                        </h:inputText>

                        <h:outputLabel value="Authors: " for="authorsTxt"/>
                        <h:inputText id="authorsTxt" value="#{publicationController.authors}" size="80">
                            <f:ajax event="valueChange" render=":editorForm:annotationsPanel :editorForm:changesPanel"
                                    listener="#{publicationController.changed}"/>
                        </h:inputText>

                        <h:outputLabel value="Journal: " for="journalTxt"/>
                        <h:inputText id="journalTxt" value="#{publicationController.journal}" size="50">
                            <f:ajax event="valueChange" render=":editorForm:annotationsPanel :editorForm:changesPanel"
                                    listener="#{publicationController.changed}"/>
                        </h:inputText>

                        <h:outputLabel value="Year: " for="yearTxt"/>
                        <h:inputText id="yearTxt" value="#{publicationController.year}" size="4" maxlength="4">
                            <f:convertNumber pattern="#"/>
                            <f:ajax event="valueChange" render=":editorForm:annotationsPanel :editorForm:changesPanel"
                                    listener="#{publicationController.changed}"/>
                        </h:inputText>

                        <h:outputLabel value="Dataset(s): " for="datasetsMenu"/>
                        <h:panelGroup id="datasetsMenu">
                            <ui:param name="datasetHeight"
                                      value="#{18 * fn:length(publicationController.datasetsSelectItems)}"/>
                            <h:selectManyMenu value="#{publicationController.datasetsToRemove}"
                                              rendered="#{not empty publicationController.datasetsSelectItems}"
                                              style="height:#{datasetHeight != 0? datasetHeight : 18}px">
                                <f:selectItems value="#{publicationController.datasetsSelectItems}"/>
                            </h:selectManyMenu>

                            <p:commandButton value="Remove" actionListener="#{publicationController.removeDatasets}"
                                             update="datasetsMenu,annotationsPanel,changesPanel"
                                             rendered="#{not empty publicationController.datasetsSelectItems}"/>
                            <h:selectOneMenu value="#{publicationController.datasetToAdd}">
                                <f:selectItems value="#{datasetPopulator.allDatasetSelectItems}"/>
                            </h:selectOneMenu>
                            <p:commandButton value="Add" actionListener="#{publicationController.addDataset}"
                                             update="datasetsMenu,annotationsPanel,changesPanel"/>
                        </h:panelGroup>

                        <h:outputLabel value="On hold: " for="onHoldTxt"/>
                        <h:panelGroup>
                            <h:inputText id="onHoldTxt" value="#{publicationController.onHold}" size="50">
                                <f:ajax event="valueChange" render=":editorForm:annotationsPanel :editorForm:onHoldWarningPanel :editorForm:changesPanel"
                                    listener="#{publicationController.changed}"/>
                            </h:inputText>
                            <p:commandButton value="Clear"
                                             onclick="document.getElementById('basicInfoPanel:onHoldTxt').value = ''"
                                             update="onHoldWarningPanel,annotationsPanel"/>
                        </h:panelGroup>
                    </ia:panelFormLayout>

                </p:outputPanel>

                <h3>Publication properties</h3>

                <h4>Xrefs</h4>
                <ia:xrefsTable value="#{publicationController.publication.xrefs}"/>

                <h4>Annotations</h4>
                <p:outputPanel id="annotationsPanel">
                    <ia:annotationsTable annotatedObjectController="#{publicationController}"
                                         topicSelectItems="#{cvObjectService.publicationTopicSelectItems}"
                                         update="annotationsPanel"
                                         render=":editorForm:basic"/>
                </p:outputPanel>

                <h3>Experiments (#{fn:length(publicationController.publication.experiments)})</h3>

                <ia:experimentsTable value="#{publicationController.publication.experiments}"/>

            </p:outputPanel>

        </h:panelGroup>

        <p:outputPanel id="changesPanel">
            <h:panelGroup rendered="#{publicationController.unsavedChanges}">

            <div class="intact-notSavedPanel">
                    Changes not yet saved &#160;
                <p:commandButton value="Save" actionListener="#{publicationController.doSave}" ajax="false"/>
            </div>

            </h:panelGroup>
        </p:outputPanel>


    </ui:define>


</ui:composition>