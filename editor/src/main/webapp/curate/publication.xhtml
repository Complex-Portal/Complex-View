<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:c="http://java.sun.com/jsp/jstl/core"
                xmlns:fn="http://java.sun.com/jsp/jstl/functions"
                xmlns:p="http://primefaces.prime.com.tr/ui"
                xmlns:ia="http://java.sun.com/jsf/composite/components/intact"

                template="/curate/curate_template.xhtml">


    <ui:param name="annotatedObjectController" value="#{publicationController}"/>

    <ui:define name="breadcrumbs">
        <p:breadCrumb>
            <p:menuitem ajax="false" onclick="loadDialog.show()" value="#{publicationController.publication.shortLabel}"
                        action="/curate/publication?includeViewParams=true&amp;faces-redirect=true"/>
            <p:menuitem ajax="false" onclick="loadDialog.show()" value="#{publicationController.publication.shortLabel}"
                        action="/curate/publication?includeViewParams=true&amp;faces-redirect=true"/>
        </p:breadCrumb>
    </ui:define>

    <ui:define name="curateContent">
        <p:hotkey bind="alt+s" actionListener="#{publicationController.doSave}"
                  update="publicationDetails,northUnit,growl,changesPanel"/>

        <f:metadata>
            <f:viewParam name="ac" value="#{publicationController.ac}"/>
            <f:event type="preRenderView" listener="#{publicationController.loadData}"/>
        </f:metadata>

        <br/><br/>

        <h:panelGroup rendered="#{publicationController.publication == null}">
            <ia:panelMessage level="warn">
                No publication loaded!
            </ia:panelMessage>

            <p>
                You may want to&#160;
                <p:commandLink value="create" onclick="newPublicationDlg.show();"/>
                a new one or&#160;
                <p:commandLink value="load" onclick="openByPmidDlg.show();"/>
                an existing one.
            </p>
        </h:panelGroup>

        <h:panelGroup>

        <h:panelGroup rendered="#{publicationController.publication != null}">

                <p:panel id="basic" header="Publication Details">

                    <p:outputPanel id="infoPanels">
                        <h:panelGroup rendered="#{not empty publicationController.acceptedMessage}">
                            <ia:panelMessage level="info">
                                This publication is <b>accepted</b>. #{publicationController.acceptedMessage}
                            </ia:panelMessage>
                        </h:panelGroup>

                        <h:panelGroup rendered="#{not empty publicationController.onHold}">
                            <ia:panelMessage level="warn">
                                This publication is <b>on-hold</b>. Reason: #{publicationController.onHold}
                                &#160;&#160;&#160;
                                <p:commandButton value="Clear" onclick="document.getElementById('clearOnHoldBtn').click();" />
                            </ia:panelMessage>
                        </h:panelGroup>

                        <h:panelGroup rendered="#{publicationController.publication.shortLabel != null and empty publicationController.publication.fullName}">
                            <ia:panelMessage level="error">
                                This publication does not contain some essential data (e.g. title).
                                <p:commandButton value="Try to fix" actionListener="#{publicationController.doFormAutocomplete}"
                                                 update="basic,publicationTabs,changesPanel">
                                    <f:setPropertyActionListener value="#{true}" target="#{publicationController.unsavedChanges}"/>
                                </p:commandButton>

                            </ia:panelMessage>
                        </h:panelGroup>
                    </p:outputPanel>

                    <h:panelGroup rendered="#{publicationController.publication != null}">
                        <div id="auditInfo" class="intact-auditPanel" >
                            <ia:creatorUpdator annotatedObject="#{publicationController.publication}" />
                        </div>
                    </h:panelGroup>

                    <!--<ia:panelFormLayout id="basicInfoPanel" columns="1">-->

                        <table class="intact-tableBasicForm">
                            <tr>
                                <td class="firstCell">
                                    <h:outputLabel value="Identifier: " for="idTxt"/>
                                </td>
                                <td>
                                    <h:inputText id="idTxt" value="#{publicationController.publication.shortLabel}"
                                                 size="10" onkeyup="enableAutocomplete()"
                                                 required="true" requiredMessage="Identifier is required">
                                        <f:ajax event="valueChange" render=":editorForm:changesPanel :editorForm:xrefsPanel"
                                                execute="@this" listener="#{publicationController.changed}"/>
                                    </h:inputText>

                                    <p:remoteCommand name="enableAutocomplete" update="autocompleteBtn" async="true">
                                        <f:setPropertyActionListener value="#{true}"
                                                                     target="#{requestScope.autocompleteEnabled}"/>
                                    </p:remoteCommand>

                                    <p:commandButton id="autocompleteBtn" value="Auto-complete"
                                                     disabled="#{not requestScope.autocompleteEnabled}"
                                                     actionListener="#{publicationController.doFormAutocomplete}" async="true"
                                                     update="publicationDetails,northUnit,growl">
                                        <!--<p:confirmDialog yesLabel="Auto-complete" noLabel="Not now" width="300px"-->
                                        <!--draggable="false"-->
                                        <!--message="Auto-completing an existing publication will update its cross references and annotations. Are you sure?"-->
                                        <!--header="Auto-complete confirmation" severity="warn"/>-->
                                    </p:commandButton>
                                </td>
                                <td style="padding-left: 45px;">
                                    <h:outputLabel value="AC: " for="acTxt" class="intact-disabled"/>
                                    <h:inputText id="acTxt" value="#{publicationController.publication.ac}"
                                                 size="10" disabled="true" class="intact-disabled"/>
                                </td>
                                <td style="text-align:right;">
                                    <h:outputLabel value="IMEx Id: " for="imexIdTxt" class="intact-disabled"/>
                                    <h:inputText id="imexIdTxt" value="#{publicationController.imexId}" size="10" disabled="true" class="intact-disabled"/>
                                </td>
                            </tr>
                            <tr>
                                <td class="firstCell">
                                    <h:outputLabel value="Title: " for="titleTxt"/>
                                </td>
                                <td colspan="2">
                                    <h:inputTextarea id="titleTxt" value="#{publicationController.publication.fullName}" cols="60" rows="1">
                                        <f:ajax event="valueChange" render=":editorForm:changesPanel"
                                                execute="@this" listener="#{publicationController.changed}"/>
                                    </h:inputTextarea>
                                </td>
                                <td colspan="1" style="text-align: right;">
                                    <h:outputLabel value="Year: " for="yearTxt"/>
                                    <p:spinner id="yearTxt" value="#{publicationController.year}"
                                               min="1950" max="2020" maxlength="4" stepFactor="1"
                                               validatorMessage="Invalid year"
                                               style="width:50px"
                                               onchange="markAsUnsaved()"/>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="1" class="firstCell">
                                    <h:outputLabel value="Author submitted: " for="submittedTxt"/>
                                </td>
                                <td colspan="3">
                                    <h:inputText id="submittedTxt" value="#{publicationController.submitted}" size="50">
                                        <f:ajax event="valueChange" render=":editorForm:annotationsPanel :editorForm:changesPanel"
                                                execute="@this" listener="#{publicationController.changed}"/>
                                    </h:inputText>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="1" class="firstCell">
                                    <h:outputLabel value="Curation request: " for="curationReqTxt"/>
                                </td>
                                <td colspan="3">
                                    <h:inputText id="curationReqTxt" value="#{publicationController.curationRequest}" size="50">
                                        <f:ajax event="valueChange" render=":editorForm:annotationsPanel :editorForm:changesPanel"
                                                execute="@this" listener="#{publicationController.changed}"/>
                                    </h:inputText>
                                </td>
                            </tr>
                            <tr>
                                <td class="firstCell">
                                    <h:outputLabel value="Dataset(s): " for="datasetsMenu"/>
                                </td>
                                <td colspan="3">
                                    <h:panelGroup id="datasetsMenu">
                                        <ui:param name="datasetHeight"
                                                  value="#{18 * fn:length(publicationController.datasetsSelectItems)}"/>
                                        <h:selectManyMenu value="#{publicationController.datasetsToRemove}"
                                                          rendered="#{not empty publicationController.datasetsSelectItems}"
                                                          style="height:#{datasetHeight != 0? datasetHeight : 18}px">
                                            <f:selectItems value="#{publicationController.datasetsSelectItems}"/>
                                        </h:selectManyMenu>

                                        <p:commandButton value="Remove" actionListener="#{publicationController.removeDatasets}"
                                                         update="datasetsMenu,annotationsPanel,changesPanel"
                                                         rendered="#{not empty publicationController.datasetsSelectItems}"/>
                                        <h:selectOneMenu value="#{publicationController.datasetToAdd}">
                                            <f:selectItems value="#{datasetPopulator.allDatasetSelectItems}"/>
                                        </h:selectOneMenu>
                                        <p:commandButton value="Add" actionListener="#{publicationController.addDataset}"
                                                         update="datasetsMenu,annotationsPanel,changesPanel"/>
                                    </h:panelGroup>
                                </td>
                            </tr>
                            <tr>
                                <td class="firstCell">
                                    <h:outputLabel value="On hold: " for="onHoldTxt"/>
                                </td>
                                <td colspan="3">
                                    <h:panelGroup>
                                        <h:inputText id="onHoldTxt" value="#{publicationController.onHold}" size="70">
                                            <f:ajax event="valueChange" render=":editorForm:annotationsPanel :editorForm:infoPanels :editorForm:changesPanel"
                                                    execute="@this" listener="#{publicationController.changed}"/>
                                        </h:inputText>
                                        <p:commandButton id="clearOnHoldBtn" value="Clear" actionListener="#{publicationController.setUnsavedChanges(true)}"
                                                         onclick="document.getElementById('onHoldTxt').value = ''"
                                                         update="infoPanels,annotationsPanel,changesPanel"/>
                                    </h:panelGroup>
                                </td>
                            </tr>
                        </table>

                    <!--</ia:panelFormLayout>-->

                </p:panel>

                <br/>

                <p:tabView id="publicationTabs">

                    <p:tab title="Experiments (#{fn:length(publicationController.publication.experiments)})">
                        <!--<ia:experimentsTable value="#{publicationController.publication.experiments}"/>-->
                        <div class="intact-buttonBar">
                            <p:commandButton value="New experiment" actionListener="#{experimentController.newExperiment(publicationController.publication)}"
                                             action="/curate/experiment" ajax="false"/>
                        </div>

                        <ui:include src="experiments_table.xhtml">
                            <ui:param name="value" value="#{publicationController.publication.experiments}"/>
                            <ui:param name="unsavedChangeManager" value="#{publicationController.unsavedChangeManager}"/>
                        </ui:include>
                    </p:tab>


                    <p:tab title="Properties">
                        <p:panel id="xrefsPanel" header="Xrefs (#{publicationController.publication.xrefs.size()})"
                                toggleable="true">
                            <ia:xrefsTable annotatedObjectController="#{publicationController}"
                                           databaseSelectItems="#{cvObjectService.databaseSelectItems}"
                                           qualifierSelectItems="#{cvObjectService.qualifierSelectItems}"
                                           update="xrefsPanel changesPanel"
                                           valueChangeRender=":editorForm:basic :editorForm:changesPanel"
                                           valueChangeAwareObject="#{annotatedObjectController}"/>
                        </p:panel>

                        <br/>

                        <p:panel id="annotationsPanel" header="Annotations (#{publicationController.publication.annotations.size()})"
                                toggleable="true">
                            <ia:annotationsTable annotatedObjectController="#{publicationController}"
                                                     topicSelectItems="#{cvObjectService.publicationTopicSelectItems}"
                                                     update="annotationsPanel changesPanel"
                                                     valueChangeRender=":editorForm:basic :editorForm:changesPanel"
                                                     valueChangeAwareObject="#{annotatedObjectController}"/>
                        </p:panel>

                    </p:tab>
                </p:tabView>

            </h:panelGroup>

        </h:panelGroup>

    </ui:define>

</ui:composition>